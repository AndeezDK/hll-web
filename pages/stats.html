<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - HLL Tool v0.6.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }
        
        .win-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--bg-tertiary);
            margin-top: 4px;
        }
        
        .win-bar-fill {
            background: var(--accent-green);
            transition: width 0.3s ease;
        }
        
        .faction-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .faction-allies {
            background: rgba(56, 139, 253, 0.2);
            color: var(--accent-blue);
        }
        
        .faction-axis {
            background: rgba(248, 81, 73, 0.2);
            color: var(--accent-red);
        }
        
        .map-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .map-row:last-child {
            border-bottom: none;
        }
        
        .map-name {
            flex: 1;
            font-weight: 500;
        }
        
        .map-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .map-record {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: center;
        }
        
        .map-winrate {
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }
        
        .enemy-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .enemy-row:last-child {
            border-bottom: none;
        }
        
        .enemy-name {
            flex: 1;
            font-weight: 500;
        }
        
        .enemy-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        
        .points-diff {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .points-diff.positive {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }
        
        .points-diff.negative {
            background: rgba(248, 81, 73, 0.2);
            color: var(--accent-red);
        }
        
        .role-bar-row {
            display: flex;
            align-items: center;
            padding: 6px 0;
            gap: 10px;
        }
        
        .role-bar-label {
            min-width: 90px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .role-bar-track {
            flex: 1;
            height: 14px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .role-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .role-bar-value {
            min-width: 50px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <a href="../index.html" class="nav-logo">HLL Tool</a>
        <div class="nav-links">
            <a href="../index.html" class="nav-link">Home</a>
            <a href="lineup.html" class="nav-link">Lineups</a>
            <a href="roster.html" class="nav-link">Roster</a>
            <a href="stats.html" class="nav-link active">Stats</a>
            <a href="matches.html" class="nav-link">Matches</a>
            <a href="enemies.html" class="nav-link">Enemy Intel</a>
            <a href="admin.html" class="nav-link">Admin</a>
        </div>
        <div class="nav-spacer"></div>
        <div class="nav-status">
            <span class="status-dot"></span>
            <span>Connecting...</span>
        </div>
    </nav>

    <div class="app-container">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">Team Stats</h1>
            <span class="version-badge">v0.6.5</span>
        </div>

        <!-- Tabs -->
        <div style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1);">
            <div class="stats-tab active" onclick="switchStatsTab('players')" id="tab-btn-players" style="padding: 10px 20px; cursor: pointer; color: var(--accent-orange); border-bottom: 2px solid var(--accent-orange); margin-bottom: -2px; font-weight: 600;">Player Stats</div>
            <div class="stats-tab" onclick="switchStatsTab('compare')" id="tab-btn-compare" style="padding: 10px 20px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; margin-bottom: -2px;">Team Compare</div>
        </div>

        <!-- PLAYER STATS TAB (existing content) -->
        <div id="tab-players">

        <!-- Overall Stats -->
        <div class="stat-row" id="overallStats">
            <div class="stat-box">
                <span class="stat-value" id="totalMatches">-</span>
                <span class="stat-label">Total Matches</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="totalWins">-</span>
                <span class="stat-label">Wins</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="totalLosses">-</span>
                <span class="stat-label">Losses</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="overallWinRate">-</span>
                <span class="stat-label">Win Rate</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="pointsFor">-</span>
                <span class="stat-label">Points For</span>
            </div>
            <div class="stat-box">
                <span class="stat-value" id="pointsAgainst">-</span>
                <span class="stat-label">Points Against</span>
            </div>
        </div>

        <div class="stats-grid">
            <!-- Map Stats - Allies -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="faction-badge faction-allies">‚òÖ Allies</span>
                        Map Performance
                    </span>
                </div>
                <div class="card-body" id="mapStatsAllies">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>

            <!-- Map Stats - Axis -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="faction-badge faction-axis">‚ú† Axis</span>
                        Map Performance
                    </span>
                </div>
                <div class="card-body" id="mapStatsAxis">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Enemy Team Stats -->
        <div class="card mt-lg">
            <div class="card-header">
                <span class="card-title">üéØ Enemy Team Records</span>
            </div>
            <div class="card-body" id="enemyStats">
                <div class="text-center text-muted">Loading...</div>
            </div>
        </div>

        <!-- Role Stats -->
        <div class="stats-grid mt-lg">
            <!-- Role Distribution -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üéñÔ∏è Role Distribution</span>
                </div>
                <div class="card-body" id="roleDistribution">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>

            <!-- Top by Role -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üë§ Player Role %</span>
                </div>
                <div class="card-body">
                    <div class="table-container" style="max-height: 500px; overflow: auto;">
                        <table class="data-table" id="playerRoleTable">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th class="numeric">Games</th>
                                    <th class="numeric">CMD</th>
                                    <th class="numeric">ART</th>
                                    <th class="numeric">SL</th>
                                    <th class="numeric">INF</th>
                                    <th class="numeric">SNIP</th>
                                    <th class="numeric">SPOT</th>
                                    <th class="numeric">TC</th>
                                    <th class="numeric">TANK</th>
                                    <th class="numeric">DEF</th>
                                </tr>
                            </thead>
                            <tbody id="playerRoleBody">
                                <tr><td colspan="11" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Players -->
        <div class="stats-grid mt-lg">
            <!-- Top Killers -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üèÜ Top Killers (Avg)</span>
                </div>
                <div class="card-body">
                    <table class="data-table" id="topKillersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th class="numeric">Avg Kills</th>
                                <th class="numeric">Matches</th>
                            </tr>
                        </thead>
                        <tbody id="topKillersBody">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top K/D -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">‚öîÔ∏è Top K/D Ratio</span>
                </div>
                <div class="card-body">
                    <table class="data-table" id="topKDTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th class="numeric">K/D</th>
                                <th class="numeric">Matches</th>
                            </tr>
                        </thead>
                        <tbody id="topKDBody">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top MVPs -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üåü Most MVPs</span>
                </div>
                <div class="card-body">
                    <table class="data-table" id="topMVPTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th class="numeric">MVPs</th>
                                <th class="numeric">Matches</th>
                            </tr>
                        </thead>
                        <tbody id="topMVPBody">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Best Attendance -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìÖ Best Attendance</span>
                </div>
                <div class="card-body">
                    <table class="data-table" id="topAttendanceTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th class="numeric">Attend%</th>
                                <th class="numeric">Matches</th>
                            </tr>
                        </thead>
                        <tbody id="topAttendanceBody">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Role Leaderboards -->
        <div class="card mt-lg">
            <div class="card-header">
                <span class="card-title">üéØ Role Leaderboards (PPS)</span>
                <select id="roleGroupFilter" style="background: var(--bg-input, #1a1a2e); border: 1px solid rgba(255,255,255,0.15); border-radius: 4px; color: var(--text-primary); padding: 4px 8px; font-size: 0.85rem;">
                    <option value="">Select role...</option>
                    <option value="Infantry">Infantry</option>
                    <option value="Squad Leader">Squad Leader</option>
                    <option value="Defence">Defence</option>
                    <option value="Defence SL">Defence SL</option>
                    <option value="Spotter">Spotter</option>
                    <option value="Sniper">Sniper</option>
                    <option value="Tank Crew">Tank Crew</option>
                    <option value="Commander">Commander</option>
                    <option value="Artillery">Artillery</option>
                </select>
            </div>
            <div class="card-body" id="roleLeaderboard">
                <div class="text-center text-muted">Select a role to see player rankings by PPS</div>
            </div>
        </div>

        </div><!-- end tab-players -->

        <!-- TEAM COMPARE TAB -->
        <div id="tab-compare" style="display: none;">
            
            <!-- My Team Summary -->
            <div class="card">
                <div class="card-header"><span class="card-title">üìä My Team Summary</span></div>
                <div class="card-body" id="myTeamSummary">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>

            <!-- Division Rankings -->
            <div class="card mt-lg">
                <div class="card-header">
                    <span class="card-title">üèÜ Division Rankings</span>
                    <select id="divisionFilter" style="background: var(--bg-input, #1a1a2e); border: 1px solid rgba(255,255,255,0.15); border-radius: 4px; color: var(--text-primary); padding: 4px 8px; font-size: 0.85rem;">
                        <option value="">Select division...</option>
                    </select>
                </div>
                <div class="card-body" id="divisionRankings">
                    <div class="text-center text-muted">Select a division to see rankings</div>
                </div>
            </div>

            <!-- Head-to-Head -->
            <div class="card mt-lg">
                <div class="card-header">
                    <span class="card-title">‚öîÔ∏è Head-to-Head</span>
                    <select id="h2hTeamSelect" style="background: var(--bg-input, #1a1a2e); border: 1px solid rgba(255,255,255,0.15); border-radius: 4px; color: var(--text-primary); padding: 4px 8px; font-size: 0.85rem;">
                        <option value="">Select enemy team...</option>
                    </select>
                </div>
                <div class="card-body" id="headToHead">
                    <div class="text-center text-muted">Select an enemy team for head-to-head comparison</div>
                </div>
            </div>

            <!-- Player-level Comparison -->
            <div id="playerCompareSection" style="display: none;">
                <div class="card mt-lg">
                    <div class="card-header"><span class="card-title">üë• Player Comparison ‚Äî Top 10</span></div>
                    <div class="card-body" id="playerCompare">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>

        </div><!-- end tab-compare -->

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <script src="../js/hll.js"></script>
    <script>
        async function init() {
            HLL.showLoading('Loading stats...');
            await HLL.init();
            
            if (HLL.isOnline) {
                await Promise.all([
                    loadOverallStats(),
                    loadMapStats(),
                    loadEnemyStats(),
                    loadPlayerLeaderboards(),
                    loadRoleStats()
                ]);
                initRoleLeaderboard();
            }
            
            HLL.hideLoading();
        }
        
        async function loadOverallStats() {
            try {
                const matches = await HLL.loadMatches(1000);
                
                const wins = matches.filter(m => m.result === 'W').length;
                const losses = matches.filter(m => m.result === 'L').length;
                const pointsFor = matches.reduce((sum, m) => sum + (m.my_score || 0), 0);
                const pointsAgainst = matches.reduce((sum, m) => sum + (m.enemy_score || 0), 0);
                const winRate = matches.length > 0 ? Math.round((wins / matches.length) * 100) : 0;
                
                document.getElementById('totalMatches').textContent = matches.length;
                document.getElementById('totalWins').textContent = wins;
                document.getElementById('totalLosses').textContent = losses;
                document.getElementById('overallWinRate').textContent = winRate + '%';
                document.getElementById('pointsFor').textContent = pointsFor;
                document.getElementById('pointsAgainst').textContent = pointsAgainst;
            } catch (err) {
                console.error('Error loading overall stats:', err);
            }
        }
        
        async function loadMapStats() {
            try {
                const matches = await HLL.loadMatches(1000);
                const mapStats = {};
                
                matches.forEach(m => {
                    const key = `${m.map}-${m.my_faction}`;
                    if (!mapStats[key]) {
                        mapStats[key] = { map: m.map, faction: m.my_faction, matches: 0, wins: 0, losses: 0 };
                    }
                    mapStats[key].matches++;
                    if (m.result === 'W') mapStats[key].wins++;
                    if (m.result === 'L') mapStats[key].losses++;
                });
                
                const alliesStats = Object.values(mapStats).filter(s => s.faction === 'Allies').sort((a, b) => b.matches - a.matches);
                const axisStats = Object.values(mapStats).filter(s => s.faction === 'Axis').sort((a, b) => b.matches - a.matches);
                
                renderMapStats('mapStatsAllies', alliesStats);
                renderMapStats('mapStatsAxis', axisStats);
            } catch (err) {
                console.error('Error loading map stats:', err);
            }
        }
        
        function renderMapStats(containerId, stats) {
            const container = document.getElementById(containerId);
            
            if (stats.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No matches yet</div>';
                return;
            }
            
            container.innerHTML = stats.map(s => {
                const winRate = s.matches > 0 ? Math.round((s.wins / s.matches) * 100) : 0;
                const winRateClass = winRate >= 60 ? 'text-success' : (winRate < 40 ? 'text-danger' : '');
                
                return `
                    <div class="map-row">
                        <span class="map-name">${s.map}</span>
                        <div class="map-stats">
                            <span class="map-record">${s.wins}W - ${s.losses}L</span>
                            <span class="map-winrate ${winRateClass}">${winRate}%</span>
                        </div>
                    </div>
                    <div class="win-bar">
                        <div class="win-bar-fill" style="width: ${winRate}%"></div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadEnemyStats() {
            try {
                const matches = await HLL.loadMatches(1000);
                const enemyStats = {};
                
                matches.forEach(m => {
                    const enemy = m.enemy_team;
                    if (!enemyStats[enemy]) {
                        enemyStats[enemy] = { enemy, matches: 0, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0 };
                    }
                    enemyStats[enemy].matches++;
                    if (m.result === 'W') enemyStats[enemy].wins++;
                    if (m.result === 'L') enemyStats[enemy].losses++;
                    enemyStats[enemy].pointsFor += m.my_score || 0;
                    enemyStats[enemy].pointsAgainst += m.enemy_score || 0;
                });
                
                const sorted = Object.values(enemyStats).sort((a, b) => b.matches - a.matches);
                renderEnemyStats(sorted);
            } catch (err) {
                console.error('Error loading enemy stats:', err);
            }
        }
        
        function renderEnemyStats(stats) {
            const container = document.getElementById('enemyStats');
            
            if (stats.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No matches yet</div>';
                return;
            }
            
            container.innerHTML = stats.map(s => {
                const winRate = s.matches > 0 ? Math.round((s.wins / s.matches) * 100) : 0;
                const winRateClass = winRate >= 60 ? 'text-success' : (winRate < 40 ? 'text-danger' : '');
                const pointsDiff = s.pointsFor - s.pointsAgainst;
                const pointsDiffClass = pointsDiff > 0 ? 'positive' : (pointsDiff < 0 ? 'negative' : '');
                const pointsDiffText = pointsDiff > 0 ? `+${pointsDiff}` : pointsDiff;
                
                return `
                    <div class="enemy-row">
                        <span class="enemy-name">${s.enemy}</span>
                        <div class="enemy-stats">
                            <span style="min-width: 80px;">${s.matches} matches</span>
                            <span style="min-width: 80px;">${s.wins}W - ${s.losses}L</span>
                            <span class="map-winrate ${winRateClass}" style="min-width: 50px;">${winRate}%</span>
                            <span class="points-diff ${pointsDiffClass}">${pointsDiffText} pts</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadPlayerLeaderboards() {
            try {
                const players = await HLL.loadPlayers();
                const qualified = players.filter(p => p.total_matches >= 3);
                
                // Top Killers
                const topKillers = [...qualified].sort((a, b) => (b.avg_kills || 0) - (a.avg_kills || 0)).slice(0, 10);
                renderLeaderboard('topKillersBody', topKillers, 'avg_kills');
                
                // Top K/D
                const topKD = [...qualified]
                    .map(p => ({ ...p, kd: p.total_deaths > 0 ? (p.total_kills / p.total_deaths) : 0 }))
                    .sort((a, b) => b.kd - a.kd).slice(0, 10);
                renderLeaderboard('topKDBody', topKD, 'kd', 2);
                
                // Top MVPs
                const topMVP = [...players].sort((a, b) => (b.mvp_count || 0) - (a.mvp_count || 0)).filter(p => p.mvp_count > 0).slice(0, 10);
                renderLeaderboard('topMVPBody', topMVP, 'mvp_count');
                
                // Best Attendance
                const topAttendance = [...players]
                    .filter(p => (p.total_matches + (p.no_shows || 0)) >= 5)
                    .map(p => ({ ...p, attendance: p.total_matches / (p.total_matches + (p.no_shows || 0)) * 100 }))
                    .sort((a, b) => b.attendance - a.attendance).slice(0, 10);
                renderLeaderboard('topAttendanceBody', topAttendance, 'attendance', 0, '%');
            } catch (err) {
                console.error('Error loading leaderboards:', err);
            }
        }
        
        function renderLeaderboard(tableId, players, statKey, decimals = 1, suffix = '') {
            const tbody = document.getElementById(tableId);
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data</td></tr>';
                return;
            }
            
            tbody.innerHTML = players.map((p, i) => `
                <tr>
                    <td class="center">${i + 1}</td>
                    <td>${HLL.formatPlayerName(p.name, p.team)}</td>
                    <td class="numeric">${(p[statKey] || 0).toFixed(decimals)}${suffix}</td>
                    <td class="numeric">${p.total_matches || 0}</td>
                </tr>
            `).join('');
        }
        
        async function loadRoleStats() {
            try {
                // Fetch all match_lineups
                const { data: lineups, error } = await HLL.supabase
                    .from('match_lineups')
                    .select('role, player_name, steam_id, match_id');
                
                if (error) throw error;
                if (!lineups || lineups.length === 0) {
                    document.getElementById('roleDistribution').innerHTML = '<div class="text-center text-muted">No match lineup data yet</div>';
                    document.getElementById('playerRoleBody').innerHTML = '<tr><td colspan="11" class="text-center text-muted">No match lineup data yet</td></tr>';
                    return;
                }
                
                // === ROLE DISTRIBUTION (bar chart) ===
                const roleCounts = {};
                const roleColors = {
                    'Commander': '#f5a623', 'Artillery': '#f85149', 'SL': '#388bfd',
                    'Infantry': '#3fb950', 'TC': '#bc8cff', 'Gunner': '#bc8cff',
                    'Driver': '#bc8cff', 'Spotter': '#d2a8ff', 'Sniper': '#d2a8ff',
                    'Defence': '#79c0ff', 'Streamer': '#8b949e', 'Reserve': '#484f58'
                };
                
                lineups.forEach(l => {
                    const role = l.role || 'Unknown';
                    roleCounts[role] = (roleCounts[role] || 0) + 1;
                });
                
                const totalSlots = lineups.length;
                const sortedRoles = Object.entries(roleCounts).sort((a, b) => b[1] - a[1]);
                const maxCount = sortedRoles[0] ? sortedRoles[0][1] : 1;
                
                document.getElementById('roleDistribution').innerHTML = sortedRoles.map(([role, count]) => {
                    const pct = Math.round((count / totalSlots) * 100);
                    const barPct = Math.round((count / maxCount) * 100);
                    const color = roleColors[role] || '#8b949e';
                    return `
                        <div class="role-bar-row">
                            <span class="role-bar-label">${role}</span>
                            <div class="role-bar-track">
                                <div class="role-bar-fill" style="width: ${barPct}%; background: ${color};"></div>
                            </div>
                            <span class="role-bar-value">${count} (${pct}%)</span>
                        </div>
                    `;
                }).join('');
                
                // === PER-PLAYER ROLE% TABLE ===
                // Maps to Excel Roster columns: CMD%, ART%, SL%, INF%, SNIPER%, SPOTTER%, TC%, TANK_CREW%, DEFENSE%
                const roleCategories = {
                    'CMD':  ['Commander'],
                    'ART':  ['Artillery'],
                    'SL':   ['SL'],
                    'INF':  ['Infantry'],
                    'SNIP': ['Sniper'],
                    'SPOT': ['Spotter'],
                    'TC':   ['TC'],
                    'TANK': ['Gunner', 'Driver'],
                    'DEF':  ['Defence']
                };
                
                // Count unique matches per player and role occurrences
                const playerData = {};
                lineups.forEach(l => {
                    const key = l.steam_id || l.player_name;
                    if (!playerData[key]) {
                        playerData[key] = { name: l.player_name, matches: new Set(), roleCounts: {} };
                    }
                    playerData[key].matches.add(l.match_id);
                    const role = l.role || 'Unknown';
                    playerData[key].roleCounts[role] = (playerData[key].roleCounts[role] || 0) + 1;
                });
                
                // Build table rows sorted by total matches desc
                const playerRows = Object.values(playerData)
                    .map(p => {
                        const totalMatches = p.matches.size;
                        const pcts = {};
                        for (const [cat, roles] of Object.entries(roleCategories)) {
                            const count = roles.reduce((sum, r) => sum + (p.roleCounts[r] || 0), 0);
                            pcts[cat] = totalMatches > 0 ? Math.round((count / totalMatches) * 100) : 0;
                        }
                        return { name: p.name, totalMatches, pcts };
                    })
                    .sort((a, b) => b.totalMatches - a.totalMatches);
                
                const tbody = document.getElementById('playerRoleBody');
                if (playerRows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">No data</td></tr>';
                } else {
                    tbody.innerHTML = playerRows.map(p => {
                        const cells = ['CMD','ART','SL','INF','SNIP','SPOT','TC','TANK','DEF']
                            .map(cat => {
                                const val = p.pcts[cat];
                                const cls = val >= 50 ? ' style="color: #3fb950; font-weight: 600;"'
                                          : val >= 25 ? ' style="color: #79c0ff;"'
                                          : val > 0  ? '' : ' style="color: #484f58;"';
                                return `<td class="numeric"${cls}>${val > 0 ? val + '%' : '-'}</td>`;
                            }).join('');
                        return `<tr><td>${p.name}</td><td class="numeric">${p.totalMatches}</td>${cells}</tr>`;
                    }).join('');
                }
                
            } catch (err) {
                console.error('Error loading role stats:', err);
                document.getElementById('roleDistribution').innerHTML = '<div class="text-center text-muted">Error loading role data</div>';
                document.getElementById('playerRoleBody').innerHTML = '<tr><td colspan="11" class="text-center text-muted">Error loading role data</td></tr>';
            }
        }
        
        // ============================================================================
        // ROLE LEADERBOARDS
        // ============================================================================
        function initRoleLeaderboard() {
            document.getElementById('roleGroupFilter').addEventListener('change', (e) => {
                loadRoleLeaderboard(e.target.value);
            });
        }

        async function loadRoleLeaderboard(roleGroup) {
            const section = document.getElementById('roleLeaderboard');
            if (!roleGroup) {
                section.innerHTML = '<div class="text-center text-muted">Select a role to see player rankings by PPS</div>';
                return;
            }
            
            section.innerHTML = '<div class="text-center text-muted">Loading...</div>';

            const { data, error } = await HLL.supabase
                .from('role_leaderboard')
                .select('*')
                .eq('role_group', roleGroup)
                .order('avg_pps', { ascending: false });

            if (error) {
                section.innerHTML = `<div class="text-center text-muted">Error: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                section.innerHTML = '<div class="text-center text-muted">No data for this role yet. Import matches with lineup data to populate.</div>';
                return;
            }

            // Choose which columns to emphasize based on role
            const isDefence = roleGroup === 'Defence' || roleGroup === 'Defence SL';
            const isSupport = roleGroup === 'Spotter' || roleGroup === 'Commander';
            const isTank = roleGroup === 'Tank Crew';

            section.innerHTML = `
                <table class="data-table" style="font-size: 0.85rem;">
                    <thead><tr>
                        <th>#</th>
                        <th>Player</th>
                        <th>Matches</th>
                        <th>Avg PPS</th>
                        <th>Best PPS</th>
                        <th>Avg K</th>
                        <th>Avg D</th>
                        <th>Avg K/D</th>
                        <th>Avg CE</th>
                        ${isDefence ? '<th style="color: #4ade80">Avg Def</th>' : '<th>Avg Def</th>'}
                        <th>Avg Off</th>
                        ${isSupport ? '<th style="color: #4ade80">Avg Sup</th>' : '<th>Avg Sup</th>'}
                    </tr></thead>
                    <tbody>
                        ${data.map((p, i) => `<tr>
                            <td>${i + 1}</td>
                            <td>${p.player_name}</td>
                            <td>${p.matches_in_role}</td>
                            <td><strong>${p.avg_pps}</strong></td>
                            <td>${p.best_pps}</td>
                            <td>${p.avg_kills}</td>
                            <td>${p.avg_deaths}</td>
                            <td>${p.avg_kd}</td>
                            <td>${p.avg_ce}</td>
                            <td>${p.avg_def}</td>
                            <td>${p.avg_off}</td>
                            <td>${p.avg_sup}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px;">
                    PPS = Performance Score based on combat, offense, defense, and support metrics weighted by K/D and KPM factors.
                    ${isDefence ? ' Defence players are expected to have higher defensive_pts.' : ''}
                    ${isSupport ? ' Support-oriented roles weight support_pts more heavily.' : ''}
                </p>`;
        }

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        function switchStatsTab(tab) {
            document.getElementById('tab-players').style.display = tab === 'players' ? 'block' : 'none';
            document.getElementById('tab-compare').style.display = tab === 'compare' ? 'block' : 'none';
            
            document.getElementById('tab-btn-players').style.color = tab === 'players' ? 'var(--accent-orange)' : 'var(--text-secondary)';
            document.getElementById('tab-btn-players').style.borderBottomColor = tab === 'players' ? 'var(--accent-orange)' : 'transparent';
            document.getElementById('tab-btn-compare').style.color = tab === 'compare' ? 'var(--accent-orange)' : 'var(--text-secondary)';
            document.getElementById('tab-btn-compare').style.borderBottomColor = tab === 'compare' ? 'var(--accent-orange)' : 'transparent';

            if (tab === 'compare' && !window._compareLoaded) {
                window._compareLoaded = true;
                loadCompareTab();
            }
        }

        // ============================================================================
        // COMPARE TAB
        // ============================================================================
        async function loadCompareTab() {
            await Promise.all([
                loadMyTeamSummary(),
                loadDivisionDropdown(),
                loadH2HDropdown()
            ]);
        }

        // --- MY TEAM SUMMARY ---
        async function loadMyTeamSummary() {
            const section = document.getElementById('myTeamSummary');
            const myTeam = HLL.currentTeam || 'Circle';

            // Get my team's match stats
            const { data: matches } = await HLL.supabase
                .from('matches')
                .select('*')
                .eq('my_team', myTeam);

            // Get my team's player stats from match_details
            const { data: details } = await HLL.supabase
                .from('match_details')
                .select('kills, deaths, combat_eff')
                .eq('team', 'Friendly');

            if (!matches || matches.length === 0) {
                section.innerHTML = '<div class="text-center text-muted">No matches found</div>';
                return;
            }

            const totalMatches = matches.length;
            const wins = matches.filter(m => m.result === 'W').length;
            const losses = matches.filter(m => m.result === 'L').length;
            const draws = matches.filter(m => m.result === 'D').length;
            const winRate = totalMatches > 0 ? Math.round(wins / totalMatches * 100) : 0;
            const ptsFor = matches.reduce((s, m) => s + (m.my_score || 0), 0);
            const ptsAgainst = matches.reduce((s, m) => s + (m.enemy_score || 0), 0);

            const totalKills = (details || []).reduce((s, d) => s + (d.kills || 0), 0);
            const totalDeaths = (details || []).reduce((s, d) => s + (d.deaths || 0), 0);
            const avgKillsPerMatch = totalMatches > 0 ? (totalKills / totalMatches).toFixed(0) : '-';
            const avgDeathsPerMatch = totalMatches > 0 ? (totalDeaths / totalMatches).toFixed(0) : '-';
            const teamKD = totalDeaths > 0 ? (totalKills / totalDeaths).toFixed(2) : '-';

            // Get my divisions
            const { data: myDivs } = await HLL.supabase
                .from('my_team_divisions')
                .select('division_id')
                .eq('team_name', myTeam);
            let divNames = [];
            if (myDivs && myDivs.length > 0) {
                const { data: divData } = await HLL.supabase
                    .from('divisions')
                    .select('name')
                    .in('id', myDivs.map(d => d.division_id));
                divNames = (divData || []).map(d => d.name);
            }

            section.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <span style="font-size: 1.2rem; font-weight: 700;">${myTeam}</span>
                    ${divNames.length > 0 ? '<span style="margin-left: 8px;">' + divNames.map(n => `<span style="padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; background: rgba(255,152,0,0.15); color: #ff9800;">${n}</span>`).join(' ') + '</span>' : ''}
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                    <div class="stat-box"><span class="stat-value">${totalMatches}</span><span class="stat-label">Matches</span></div>
                    <div class="stat-box"><span class="stat-value" style="color: var(--accent-green)">${wins}</span><span class="stat-label">Wins</span></div>
                    <div class="stat-box"><span class="stat-value" style="color: var(--accent-red)">${losses}</span><span class="stat-label">Losses</span></div>
                    <div class="stat-box"><span class="stat-value">${winRate}%</span><span class="stat-label">Win Rate</span></div>
                    <div class="stat-box"><span class="stat-value">${ptsFor}-${ptsAgainst}</span><span class="stat-label">Score F/A</span></div>
                    <div class="stat-box"><span class="stat-value" style="color: ${parseFloat(teamKD) >= 1 ? 'var(--accent-green)' : 'var(--accent-red)'}">${teamKD}</span><span class="stat-label">Team K/D</span></div>
                    <div class="stat-box"><span class="stat-value">${avgKillsPerMatch}</span><span class="stat-label">Avg Kills/Match</span></div>
                    <div class="stat-box"><span class="stat-value">${avgDeathsPerMatch}</span><span class="stat-label">Avg Deaths/Match</span></div>
                </div>`;
        }

        // --- DIVISION RANKINGS ---
        async function loadDivisionDropdown() {
            const { data: divs } = await HLL.supabase
                .from('divisions')
                .select('*')
                .order('sort_order', { ascending: true });
            
            const select = document.getElementById('divisionFilter');
            (divs || []).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = d.name;
                select.appendChild(opt);
            });
            select.addEventListener('change', () => loadDivisionRankings(select.value));
        }

        async function loadDivisionRankings(divisionId) {
            const section = document.getElementById('divisionRankings');
            if (!divisionId) {
                section.innerHTML = '<div class="text-center text-muted">Select a division to see rankings</div>';
                return;
            }

            section.innerHTML = '<div class="text-center text-muted">Loading...</div>';

            // Get division name
            const { data: divData } = await HLL.supabase
                .from('divisions')
                .select('name')
                .eq('id', divisionId)
                .single();
            const divName = divData?.name || '';

            // Get all enemy teams in this division
            const { data: teamLinks } = await HLL.supabase
                .from('enemy_team_divisions')
                .select('team_tag')
                .eq('division_id', divisionId);
            const enemyTags = (teamLinks || []).map(t => t.team_tag);

            // Check if my team is in this division
            const myTeam = HLL.currentTeam || 'Circle';
            const { data: myInDiv } = await HLL.supabase
                .from('my_team_divisions')
                .select('id')
                .eq('team_name', myTeam)
                .eq('division_id', divisionId);
            const myTeamInDiv = myInDiv && myInDiv.length > 0;

            // Get ALL matches of this division type (filtered by match_type)
            const { data: divMatches } = await HLL.supabase
                .from('matches')
                .select('*')
                .eq('match_type', divName);

            // Build rankings array
            const rankings = [];

            // Calculate stats per enemy team from division matches only
            for (const tag of enemyTags) {
                const teamMatches = (divMatches || []).filter(m => m.enemy_team === tag);
                if (teamMatches.length === 0) {
                    rankings.push({ tag, name: tag, matches: 0, wins: 0, losses: 0, winRate: 0, ptsFor: 0, ptsAgainst: 0, isMyTeam: false });
                    continue;
                }
                // From our perspective: our W = their L, our L = their W
                const theirWins = teamMatches.filter(m => m.result === 'L').length;
                const theirLosses = teamMatches.filter(m => m.result === 'W').length;
                rankings.push({
                    tag,
                    name: tag,
                    matches: teamMatches.length,
                    wins: theirWins,
                    losses: theirLosses,
                    winRate: teamMatches.length > 0 ? Math.round(theirWins / teamMatches.length * 100) : 0,
                    ptsFor: teamMatches.reduce((s, m) => s + (m.enemy_score || 0), 0),
                    ptsAgainst: teamMatches.reduce((s, m) => s + (m.my_score || 0), 0),
                    isMyTeam: false
                });
            }

            // Get my team stats (only matches of this division type)
            const myMatches = (divMatches || []).filter(m => m.my_team === myTeam);

            // Add my team if in this division
            if (myTeamInDiv && myMatches.length > 0) {
                const mw = myMatches.filter(m => m.result === 'W').length;
                const ml = myMatches.filter(m => m.result === 'L').length;
                rankings.push({
                    tag: myTeam,
                    name: myTeam,
                    matches: myMatches.length,
                    wins: mw,
                    losses: ml,
                    winRate: myMatches.length > 0 ? Math.round(mw / myMatches.length * 100) : 0,
                    ptsFor: myMatches.reduce((s, m) => s + (m.my_score || 0), 0),
                    ptsAgainst: myMatches.reduce((s, m) => s + (m.enemy_score || 0), 0),
                    isMyTeam: true
                });
            }

            // Sort by win rate desc, then wins desc
            rankings.sort((a, b) => b.winRate - a.winRate || b.wins - a.wins);

            if (rankings.length === 0) {
                section.innerHTML = '<div class="text-center text-muted">No teams found in this division</div>';
                return;
            }

            section.innerHTML = `
                <table class="data-table">
                    <thead><tr>
                        <th>#</th><th>Team</th><th>Matches</th><th>W</th><th>L</th><th>Win Rate</th><th>Pts F/A</th>
                    </tr></thead>
                    <tbody>
                        ${rankings.map((t, i) => `
                            <tr style="${t.isMyTeam ? 'background: rgba(255,152,0,0.1); font-weight: 600;' : ''}">
                                <td>${i + 1}</td>
                                <td>${t.isMyTeam ? '‚≠ê ' : ''}[${t.tag}] ${t.name !== t.tag ? t.name : ''}</td>
                                <td>${t.matches}</td>
                                <td style="color: var(--accent-green)">${t.wins}</td>
                                <td style="color: var(--accent-red)">${t.losses}</td>
                                <td><strong>${t.winRate}%</strong></td>
                                <td>${t.ptsFor}-${t.ptsAgainst}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        // --- HEAD TO HEAD ---
        async function loadH2HDropdown() {
            const { data: teams } = await HLL.supabase
                .from('enemy_teams')
                .select('tag, name')
                .order('tag');
            
            const select = document.getElementById('h2hTeamSelect');
            (teams || []).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.tag;
                opt.textContent = `[${t.tag}] ${t.name || ''}`;
                select.appendChild(opt);
            });
            select.addEventListener('change', () => loadHeadToHead(select.value));
        }

        async function loadHeadToHead(enemyTag) {
            const section = document.getElementById('headToHead');
            const playerSection = document.getElementById('playerCompareSection');
            if (!enemyTag) {
                section.innerHTML = '<div class="text-center text-muted">Select an enemy team for head-to-head comparison</div>';
                playerSection.style.display = 'none';
                return;
            }

            section.innerHTML = '<div class="text-center text-muted">Loading...</div>';
            const myTeam = HLL.currentTeam || 'Circle';

            // Get matches against this team
            const { data: matches } = await HLL.supabase
                .from('matches')
                .select('*')
                .eq('enemy_team', enemyTag);

            if (!matches || matches.length === 0) {
                section.innerHTML = '<div class="text-center text-muted">No matches found against this team</div>';
                playerSection.style.display = 'none';
                return;
            }

            const matchIds = matches.map(m => m.match_id);

            // Get all match_details for these matches
            const { data: details } = await HLL.supabase
                .from('match_details')
                .select('*')
                .in('match_id', matchIds);

            const friendly = (details || []).filter(d => d.team === 'Friendly');
            const enemy = (details || []).filter(d => d.team === 'Enemy');

            const myKills = friendly.reduce((s, d) => s + (d.kills || 0), 0);
            const myDeaths = friendly.reduce((s, d) => s + (d.deaths || 0), 0);
            const theirKills = enemy.reduce((s, d) => s + (d.kills || 0), 0);
            const theirDeaths = enemy.reduce((s, d) => s + (d.deaths || 0), 0);

            const wins = matches.filter(m => m.result === 'W').length;
            const losses = matches.filter(m => m.result === 'L').length;
            const myKD = myDeaths > 0 ? (myKills / myDeaths).toFixed(2) : '-';
            const theirKD = theirDeaths > 0 ? (theirKills / theirDeaths).toFixed(2) : '-';
            const myAvgKills = matches.length > 0 ? (myKills / matches.length).toFixed(0) : '-';
            const theirAvgKills = matches.length > 0 ? (theirKills / matches.length).toFixed(0) : '-';

            const betterKD = parseFloat(myKD) > parseFloat(theirKD);

            section.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: start;">
                    <!-- My Team -->
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; color: var(--accent-orange);">${myTeam}</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="stat-box"><span class="stat-value" style="color: var(--accent-green)">${wins}</span><span class="stat-label">Wins</span></div>
                            <div class="stat-box"><span class="stat-value">${myKills}</span><span class="stat-label">Total Kills</span></div>
                            <div class="stat-box"><span class="stat-value">${myDeaths}</span><span class="stat-label">Total Deaths</span></div>
                            <div class="stat-box"><span class="stat-value" style="color: ${betterKD ? 'var(--accent-green)' : 'var(--accent-red)'}">${myKD}</span><span class="stat-label">K/D</span></div>
                            <div class="stat-box"><span class="stat-value">${myAvgKills}</span><span class="stat-label">Avg Kills/Match</span></div>
                        </div>
                    </div>
                    <!-- VS -->
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 40px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);">VS</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">${matches.length} matches</div>
                    </div>
                    <!-- Enemy Team -->
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">[${enemyTag}]</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="stat-box"><span class="stat-value" style="color: var(--accent-green)">${losses}</span><span class="stat-label">Wins</span></div>
                            <div class="stat-box"><span class="stat-value">${theirKills}</span><span class="stat-label">Total Kills</span></div>
                            <div class="stat-box"><span class="stat-value">${theirDeaths}</span><span class="stat-label">Total Deaths</span></div>
                            <div class="stat-box"><span class="stat-value" style="color: ${!betterKD ? 'var(--accent-green)' : 'var(--accent-red)'}">${theirKD}</span><span class="stat-label">K/D</span></div>
                            <div class="stat-box"><span class="stat-value">${theirAvgKills}</span><span class="stat-label">Avg Kills/Match</span></div>
                        </div>
                    </div>
                </div>`;

            // Load player comparison
            await loadPlayerComparison(matchIds, enemyTag);
        }

        // --- PLAYER COMPARISON ---
        async function loadPlayerComparison(matchIds, enemyTag) {
            const section = document.getElementById('playerCompareSection');
            const body = document.getElementById('playerCompare');
            section.style.display = 'block';
            body.innerHTML = '<div class="text-center text-muted">Loading...</div>';

            // Get friendly player stats for these matches
            const { data: friendlyDetails } = await HLL.supabase
                .from('match_details')
                .select('steam_id, player_name, kills, deaths')
                .in('match_id', matchIds)
                .eq('team', 'Friendly');

            // Get enemy player stats
            const { data: enemyDetails } = await HLL.supabase
                .from('match_details')
                .select('steam_id, player_name, kills, deaths')
                .in('match_id', matchIds)
                .eq('team', 'Enemy');

            // Aggregate by player
            function aggregatePlayers(details) {
                const map = {};
                (details || []).forEach(d => {
                    const key = d.steam_id || d.player_name;
                    if (!map[key]) map[key] = { name: d.player_name, kills: 0, deaths: 0, matches: 0 };
                    map[key].kills += d.kills || 0;
                    map[key].deaths += d.deaths || 0;
                    map[key].matches++;
                });
                return Object.values(map)
                    .map(p => ({ ...p, avgKills: (p.kills / p.matches).toFixed(1), kd: p.deaths > 0 ? (p.kills / p.deaths).toFixed(2) : '-' }))
                    .sort((a, b) => parseFloat(b.avgKills) - parseFloat(a.avgKills))
                    .slice(0, 10);
            }

            const myTop = aggregatePlayers(friendlyDetails);
            const theirTop = aggregatePlayers(enemyDetails);
            const maxRows = Math.max(myTop.length, theirTop.length);

            body.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <h4 style="text-align: center; margin-bottom: 8px; color: var(--accent-orange); font-size: 0.9rem;">Our Top Players</h4>
                        <table class="data-table" style="font-size: 0.85rem;">
                            <thead><tr><th>#</th><th>Name</th><th>Avg K</th><th>K/D</th></tr></thead>
                            <tbody>
                                ${myTop.map((p, i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.avgKills}</td><td>${p.kd}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4 style="text-align: center; margin-bottom: 8px; font-size: 0.9rem;">Their Top Players</h4>
                        <table class="data-table" style="font-size: 0.85rem;">
                            <thead><tr><th>#</th><th>Name</th><th>Avg K</th><th>K/D</th></tr></thead>
                            <tbody>
                                ${theirTop.map((p, i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.avgKills}</td><td>${p.kd}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }

        init();
    </script>
</body>
</html>
